<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer Mentoring Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
        /* Custom Scrollbar for better aesthetics */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-6xl mx-auto">

        <!-- Header and User Info -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">Teacher Peer Mentoring Tracker</h1>
            <p class="mt-2 text-gray-600">Documenting sessions around calm spaces, relationship building, and classroom resets.</p>
            
            <!-- SHARE LINK BLOCK -->
            <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200 flex flex-col sm:flex-row justify-between items-center shadow-inner">
                <p class="text-sm font-medium text-yellow-800 mb-2 sm:mb-0">
                    To share this tracker with your mentors/mentees, copy the application's URL.
                </p>
                <button id="share-link-btn" class="flex items-center text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 py-2 px-4 rounded-md transition duration-150 ease-in-out shadow-md w-full sm:w-auto">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.88 12.013 9.476 11 10.453 11c.976 0 1.573 1.013 1.768 2.342m-1.531 6.848a5.5 5.5 0 01-5.6-5.495c0-3.037 2.443-5.495 5.467-5.495s5.467 2.458 5.467 5.495a5.5 5.5 0 01-5.6 5.495m7.85-2.203V10.1c0-1.12-.91-2.028-2.03-2.028H6.182C5.06 8.072 4.15 8.98 4.15 10.1v3.834c0 1.12.91 2.028 2.03 2.028h11.637c1.12 0 2.03-.908 2.03-2.028zM19.333 13.92V10.1"></path></svg>
                    Copy Shareable Link
                </button>
            </div>
            <!-- END SHARE LINK BLOCK -->

            <div id="auth-status" class="mt-4 text-sm bg-blue-50 p-3 rounded-lg flex items-center justify-between shadow-sm">
                <span id="user-display" class="font-medium text-blue-700">Loading user ID...</span>
                <span id="loading-spinner" class="animate-spin h-5 w-5 border-4 border-t-blue-500 border-white rounded-full"></span>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Mentoring Log Form -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-2xl sticky top-8">
                    <h2 class="text-2xl font-bold mb-4 text-blue-700 border-b pb-2">Log New Session</h2>

                    <form id="mentoring-form" class="space-y-4">
                        
                        <div>
                            <label for="menteeName" class="block text-sm font-medium text-gray-700">Mentee's Name</label>
                            <input type="text" id="menteeName" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        
                        <div>
                            <label for="focusArea" class="block text-sm font-medium text-gray-700">Focus Area</label>
                            <select id="focusArea" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="" disabled selected>Select a focus area</option>
                                <option value="Calm Space & Routines">Calm Space Build, Expectations, & Routines</option>
                                <option value="Relationship Building">Building Positive Student Relationships</option>
                                <option value="Classroom Resets">Utilizing Classroom Resets (50%+ disregulation)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="strategiesUsed" class="block text-sm font-medium text-gray-700">Strategies & Resources Shared</label>
                            <textarea id="strategiesUsed" rows="3" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                        </div>
                        
                        <div>
                            <label for="menteeNextSteps" class="block text-sm font-medium text-gray-700">Mentee's Agreed Next Steps</label>
                            <textarea id="menteeNextSteps" rows="3" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                        </div>

                        <div>
                            <label for="sessionNotes" class="block text-sm font-medium text-gray-700">Overall Session Notes</label>
                            <textarea id="sessionNotes" rows="2"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                        </div>
                        
                        <button type="submit" id="submit-btn"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Add Mentoring Log
                        </button>
                    </form>
                    <div id="message-box" class="mt-4 p-3 rounded-lg text-center hidden"></div>
                </div>
            </div>

            <!-- Log Display Area -->
            <div class="lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-gray-800">Session History</h2>
                    <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out flex items-center disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export to CSV
                    </button>
                </div>
                
                <!-- FILTER BAR -->
                <div class="flex space-x-4 mb-4">
                    <div>
                        <label for="mentee-filter" class="block text-xs font-medium text-gray-700 mb-1">Filter by Mentee</label>
                        <select id="mentee-filter" class="w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white text-sm">
                            <option value="all">All Mentees</option>
                        </select>
                    </div>
                    <div>
                        <label for="mentor-filter" class="block text-xs font-medium text-gray-700 mb-1">Filter by Mentor</label>
                        <select id="mentor-filter" class="w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white text-sm">
                            <option value="all">All Mentors</option>
                        </select>
                    </div>
                </div>
                <!-- END FILTER BAR -->

                <div id="logs-container" class="scroll-container bg-white p-4 shadow-xl">
                    <p id="no-logs" class="text-center text-gray-500 mt-4">No mentoring sessions logged yet. Use the form to the left to add your first session!</p>
                    <div id="log-list" class="space-y-4">
                        <!-- Logs will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let currentLogs = []; // Global array to hold the log data fetched from Firestore
        let selectedMenteeFilter = 'all';
        let selectedMentorFilter = 'all';

        // UI elements
        const userDisplay = document.getElementById('user-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const form = document.getElementById('mentoring-form');
        const logList = document.getElementById('log-list');
        const noLogsMessage = document.getElementById('no-logs');
        const messageBox = document.getElementById('message-box');
        const submitBtn = document.getElementById('submit-btn');
        const exportBtn = document.getElementById('export-btn');
        const menteeFilter = document.getElementById('mentee-filter');
        const mentorFilter = document.getElementById('mentor-filter');
        const shareLinkBtn = document.getElementById('share-link-btn');


        // Helper function for UI messages
        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-3 rounded-lg text-center';
            messageBox.classList.add(isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // --- 1. INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                userDisplay.textContent = 'Authenticating...';

                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first event
                        
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        userDisplay.textContent = `User ID: ${userId}`;
                        loadingSpinner.classList.add('hidden');
                        resolve();
                    });
                });

                // Start real-time log listener after auth is complete
                setupLogListener();
                
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                userDisplay.textContent = 'Authentication Failed (Check Console)';
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // --- 2. FIRESTORE LOGIC ---
        function getLogCollectionRef() {
             // Store in a public collection so logs are easily sharable/viewable by multiple mentors/mentees
            return collection(db, `artifacts/${appId}/public/data/mentoring_logs`);
        }

        function setupLogListener() {
            if (!db) return;

            // Fetch data ordered by date descending
            const q = query(getLogCollectionRef(), orderBy("date", "desc"));

            onSnapshot(q, (snapshot) => {
                currentLogs = []; // Reset logs
                snapshot.forEach((doc) => {
                    const log = doc.data();
                    // Store log data
                    currentLogs.push(log); 
                });

                populateFilterOptions();
                applyFiltersAndRender();
                
            }, (error) => {
                console.error("Error fetching logs:", error);
            });
        }

        async function addMentoringLog(event) {
            event.preventDefault();
            
            if (!userId) {
                displayMessage("Authentication not ready. Please wait.", true);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const menteeName = document.getElementById('menteeName').value;
            const focusArea = document.getElementById('focusArea').value;
            const strategiesUsed = document.getElementById('strategiesUsed').value;
            const menteeNextSteps = document.getElementById('menteeNextSteps').value;
            const sessionNotes = document.getElementById('sessionNotes').value;

            const newLog = {
                mentorId: userId,
                menteeName: menteeName,
                focusArea: focusArea,
                strategiesUsed: strategiesUsed,
                menteeNextSteps: menteeNextSteps,
                sessionNotes: sessionNotes,
                date: serverTimestamp() // Use server timestamp for accurate ordering
            };

            try {
                await addDoc(getLogCollectionRef(), newLog);
                form.reset();
                displayMessage("Session successfully logged!");
            } catch (error) {
                console.error("Error adding document: ", error);
                displayMessage(`Error logging session: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Mentoring Log';
            }
        }
        
        // --- 3. FILTERING AND RENDERING LOGIC ---

        function populateFilterOptions() {
            const uniqueMentees = new Set();
            const uniqueMentors = new Set();
            
            currentLogs.forEach(log => {
                uniqueMentees.add(log.menteeName);
                uniqueMentors.add(log.mentorId);
            });

            // Populate Mentee Filter
            menteeFilter.innerHTML = '<option value="all">All Mentees</option>';
            Array.from(uniqueMentees).sort().forEach(mentee => {
                const option = document.createElement('option');
                option.value = mentee;
                option.textContent = mentee;
                option.selected = mentee === selectedMenteeFilter;
                menteeFilter.appendChild(option);
            });

            // Populate Mentor Filter
            mentorFilter.innerHTML = '<option value="all">All Mentors</option>';
            Array.from(uniqueMentors).sort().forEach(mentorId => {
                const option = document.createElement('option');
                const displayId = mentorId.substring(0, 8) + '...';
                option.value = mentorId;
                option.textContent = displayId;
                option.selected = mentorId === selectedMentorFilter;
                mentorFilter.appendChild(option);
            });
        }

        function applyFiltersAndRender() {
            logList.innerHTML = ''; // Clear existing logs
            
            // Check if there are any logs at all
            if (currentLogs.length === 0) {
                noLogsMessage.classList.remove('hidden');
                exportBtn.disabled = true;
                return;
            }

            // Apply filters to currentLogs
            const filteredLogs = currentLogs.filter(log => {
                const isMenteeMatch = selectedMenteeFilter === 'all' || log.menteeName === selectedMenteeFilter;
                const isMentorMatch = selectedMentorFilter === 'all' || log.mentorId === selectedMentorFilter;
                return isMenteeMatch && isMentorMatch;
            });

            // Render filtered logs
            if (filteredLogs.length === 0) {
                noLogsMessage.textContent = 'No sessions match the current filter selection.';
                noLogsMessage.classList.remove('hidden');
            } else {
                noLogsMessage.classList.add('hidden');
                filteredLogs.forEach((log) => {
                    logList.appendChild(createLogCard(log));
                });
            }

            // Enable export button if logs exist (regardless of filter, since export uses currentLogs)
            exportBtn.disabled = currentLogs.length === 0;
        }


        function createLogCard(log) {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-xl shadow-md border-l-4 border-blue-500 hover:shadow-lg transition duration-200';
            
            // Format date
            const date = log.date ? new Date(log.date.toDate()).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            }) : 'Pending Date...';

            const mentorDisplayId = log.mentorId.substring(0, 8) + '...';

            // Card content
            card.innerHTML = `
                <div class="flex justify-between items-start border-b pb-2 mb-2">
                    <h3 class="text-xl font-semibold text-gray-800">${log.menteeName} <span class="text-sm font-normal text-gray-500 ml-2">(${log.focusArea})</span></h3>
                    <div class="text-sm text-gray-500">${date}</div>
                </div>
                
                <div class="space-y-3 mt-3 text-sm">
                    <p><strong>Shared Strategies:</strong> <span class="text-gray-600">${log.strategiesUsed}</span></p>
                    <p class="p-2 bg-yellow-50 rounded-md border-l-2 border-yellow-500">
                        <strong>Mentee Next Steps:</strong> <span class="text-gray-700 font-medium">${log.menteeNextSteps}</span>
                    </p>
                    ${log.sessionNotes ? `<p><strong>Notes:</strong> <span class="text-gray-600">${log.sessionNotes}</span></p>` : ''}
                    <p class="text-xs text-gray-400">Logged by: ${mentorDisplayId}</p>
                </div>
            `;
            
            return card;
        }

        // --- 4. EXPORT AND UTILITY LOGIC ---
        
        // Function to copy text to clipboard (using deprecated execCommand as fallback for iFrames)
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            // Make the text field invisible but selectable
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    displayMessage("Link copied to clipboard! Share the URL with your team.", false);
                } else {
                    displayMessage("Could not copy link automatically. Please copy the browser's URL manually.", true);
                }
            } catch (err) {
                console.error('Copy command failed:', err);
                displayMessage("Could not copy link automatically. Please copy the browser's URL manually.", true);
            }
            document.body.removeChild(textarea);
        }

        function convertToCSV(data) {
            const header = [
                "Date", 
                "MenteeName", 
                "FocusArea", 
                "StrategiesShared", 
                "MenteeNextSteps", 
                "SessionNotes", 
                "MentorId"
            ];
            let csv = header.join(',') + '\n';

            data.forEach(log => {
                // Function to sanitize text for CSV: remove newlines and escape double quotes
                const sanitize = (text) => {
                    if (!text) return '""';
                    // Replace newlines with spaces and escape double quotes
                    let cleaned = String(text).replace(/\n/g, ' ').replace(/"/g, '""');
                    // Wrap in double quotes in case commas or other special characters remain
                    return `"${cleaned}"`; 
                };

                const dateString = log.date ? new Date(log.date.toDate()).toISOString().split('T')[0] : '';
                const row = [
                    dateString,
                    sanitize(log.menteeName),
                    sanitize(log.focusArea),
                    sanitize(log.strategiesUsed),
                    sanitize(log.menteeNextSteps),
                    sanitize(log.sessionNotes),
                    sanitize(log.mentorId)
                ];
                csv += row.join(',') + '\n';
            });
            return csv;
        }

        function exportToCSV() {
            if (currentLogs.length === 0) {
                displayMessage("No logs available to export.", true);
                return;
            }
            
            const csvContent = convertToCSV(currentLogs);
            
            // Create a Blob containing the CSV data
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create a temporary link element to trigger the download
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Mentoring_Tracker_Export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            // Append link to body, click it, and remove it
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up the temporary URL
            
            displayMessage("Data exported successfully to CSV!", false);
        }

        // --- 5. EVENT LISTENERS AND START ---
        form.addEventListener('submit', addMentoringLog);
        exportBtn.addEventListener('click', exportToCSV);
        
        // Add event listeners for the new filters
        menteeFilter.addEventListener('change', (e) => {
            selectedMenteeFilter = e.target.value;
            applyFiltersAndRender();
        });

        mentorFilter.addEventListener('change', (e) => {
            selectedMentorFilter = e.target.value;
            applyFiltersAndRender();
        });
        
        // New listener for the share button
        shareLinkBtn.addEventListener('click', () => {
            // window.location.href gives the URL of the running application, which is the link to share.
            copyToClipboard(window.location.href);
        });


        window.onload = initializeFirebase;
    </script>
</body>
</html>